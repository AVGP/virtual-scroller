<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <button onclick="window.stopTests = true; this.remove()">stop</button>
  <pre id="outEl"></pre>
  <script type="module">
    import { streamsTime, renderTime, innerHTMLTime } from './tests.js';

    window.stopTests = false;
    runTests();

    async function runTests(runs = 5) {
      outEl.textContent += `-- parse with streams --\n\n`;
      await runTest(streamsTime, runs);

      outEl.textContent += `\n\n-- render time --\n\n`;
      await runTest(renderTime, runs, { tagName: 'template' });
      await runTest(renderTime, runs, { tagName: 'template', attach: true });
      await runTest(renderTime, runs, { tagName: 'div' });
      await runTest(renderTime, runs, { tagName: 'div', attach: true, hidden: true });
      await runTest(renderTime, runs, { tagName: 'div', attach: true });

      outEl.textContent += `\n\n-- innerHTML time --\n\n`;
      await runTest(innerHTMLTime, runs, { tagName: 'template' });
      await runTest(innerHTMLTime, runs, { tagName: 'template', attach: true });
      await runTest(innerHTMLTime, runs, { tagName: 'div' });
      await runTest(innerHTMLTime, runs, { tagName: 'div', attach: true, hidden: true });
      await runTest(innerHTMLTime, runs, { tagName: 'div', attach: true });

      alert('done!');
    }

    async function runTest(test, runs, { tagName, attach = false, hidden = false } = {}) {
      if (window.stopTests) return;

      outEl.textContent += tagName ?
        `<${tagName}> x ${runs}, attach? ${attach} hidden? ${hidden}\n\n` :
        `${runs} runs\n\n`;
      let sum = 0;
      for (let i = 0; i < runs; i++) {
        if (window.stopTests) break;

        const elem = tagName ? document.createElement(tagName) : null;
        if (elem) {
          elem.style.display = hidden ? 'none' : null;
          attach && document.body.appendChild(elem);
        }
        const time = await test(elem);
        sum += time;
        outEl.textContent += `#${i + 1}\t${time.toFixed(2)}\n`;
        if (elem) {
          // Cleanup.
          elem.remove();
          document.querySelectorAll('body > a').forEach(child => child.remove());
        }
      }
      outEl.textContent += `\navg\t${(sum / runs).toFixed(2)}\n\n`;
    }
  </script>
</body>

</html>